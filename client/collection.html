<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <!-- <link rel="stylesheet" type="text/css" href="/style.css"> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  
  <script>
    let tankList = [];

    const sortTankList = (method) => {
      switch(method){
        case 'name':
          tankList.sort();
          break;

        case 'nation':
          tankList.sort((a, b) => (a.nation > b.nation) ? 1 : -1);
          break;

        case 'year':
          tankList.sort((a, b) => (a.year > b.year) ? 1 : -1);
          break;

        case 'year':
          tankList.sort((a, b) => (a.produced > b.produced) ? 1 : -1);
          break;

        default:
          tankList.sort();
          break;
      }
    }

    const handleResponse = async (response) => {
      // Reference to page content
      const content = document.getElementById('content');

      // Page content changes based on the response status code
      switch(response.status){
        case 200:
          content.innerHTML = `<b>Success</b>`;
          break;

        case 201:
          content.innerHTML = `<b>Created</b>`;
          break;

        case 204:
          content.innerHTML = `<b>Updated (No Content)</b>`;
          break;

        case 400:
          content.innerHTML = `<b>Bad Request</b>`;
          break;

        case 404:
          content.innerHTML = `<b>Not Found</b>`;
          break;

        default:
          content.innerHTML = `<b>Error</b> - Code not implemented by client.`;
          break;
      }

      // Additional page content depends on the request method and responding status code(s)
      let object = await response.json();
      if(response.status === 404){
        let jsonString = JSON.stringify(object.message);
        content.innerHTML += `<p>Message: ${jsonString}</p>`;
      }else if(response.status === 201 || response.status === 400){
        let object = await response.json();
        let jsonString = JSON.stringify(object.message);
        content.innerHTML += `<p>Message: ${jsonString}</p>`;
      }else{
        // for(let tank in object.users)
        // {
        //   tankList.push(tank)
        // }
        let tankString = JSON.stringify(object.users);
        tankList = Object.value(JSON.parse(tankString));

        sortTankList(document.getElementById('sortField').value);

        tankList.forEach(tank => {
          content.innerHTML += `
             <div class="card has-text-centered">
              <div class="card-image">
                <figure class="image p-3 is-inline-block">
                  <img src="${object.users[tank].image}" alt="Tank">
                </figure>
              </div>
              <div class="content is-size-6 pb-3">
                Tank: ${object.users[tank].name}
                <br>
                Nation: ${object.users[tank].nation}
                <br>
                Year Designed: ${object.users[tank].year}
                <br>
                # Produced: ${object.users[tank].produced}
                <br>
                Description: ${object.users[tank].description}
              </div>
            </div>
          `;
        });
      }
    };

    // requestUpdate Method - Handles getting content from server (GET and HEAD)
    const requestUpdate = async (userForm) => {
      const sortField = userForm.querySelector('#sortField').value;

      let response = await fetch('/getTanks', {
        method:'GET',
        headers: {'Accept':'application.json'},
      });

      handleResponse(response);
    }

    const loadBurger = () => {
      const burgerIcon = document.getElementById('burger');
      const navbarMenu = document.getElementById('nav-links');
      burgerIcon.addEventListener('click', () => { navbarMenu.classList.toggle('is-active') });
    };

    // init Method - Adds events to page buttons upon page loading
    const init = () => {
      const userForm = document.getElementById('userForm');

      const getTanks = (e) => {
        e.preventDefault();
        requestUpdate(userForm);
        return false;
      }
      
      userForm.addEventListener('submit', getTanks);

      loadBurger();
    };

    window.onload = init;
  </script>
</head>
<body>
  <nav class="navbar has-shadow is-white">
    <div class="navbar-brand">
        <a class="navbar-item" href="client.html">
            <img src="https://cdn-icons-png.flaticon.com/512/8206/8206245.png" alt="tank icon">
        </a>
        <a class="navbar-burger" id="burger">
            <span></span>
            <span></span>
            <span></span>
        </a>
    </div>

    <div class="navbar-menu" id="nav-links">
        <div id="nav-bar" class="navbar-start">
            <a id="home" class="navbar-item is-hoverable" href="client.html">
                Page 1
            </a>
        
            <a id="collection" class="navbar-item is-hoverable" href="collection.html">
                Page 2
            </a>
        
            <a id="documentation" class="navbar-item is-hoverable" href="documentation.html">
                Documentation
            </a>
        </div>
    </div>
</nav>
  <section id="top" class="section has-background-success-dark">
    <div class="has-text-centered is-vcentered has-background-warning-light">
      <h3>Tank Collection Manager</h3>
      <form id="userForm" action="/getTanks" method="get">
        
        <label for="sortField">Sort tanks by: </label>
        <select id='sortField' name="sortField">
          <option value='name'>Name</option>
          <option value='nation'>Nation</option>
          <option value='year'>Year Designed</option>
          <option value='produced'>Number Produced</option>
        </select>
        <input type="submit" value="Get Tanks" />
      </form>
    </div>
  </section>
  <section id="content">
  </section>
</body>
</html>
